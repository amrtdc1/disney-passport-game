<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Disney Passport Collector</title>
<meta name="description" content="Collect passport stamps from people around the world at Disney!">
<meta name="theme-color" content="#0D1B3E">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Passport">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-512.png">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">

<!-- Firebase COMPAT SDK - works on all browsers including iOS Safari -->

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
:root {
  --gold: #F4C04B;
  --gold-dark: #C9962A;
  --navy: #0D1B3E;
  --navy-light: #1A2F5E;
  --cream: #FDF6E3;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: 'DM Sans', sans-serif;
  background: var(--navy);
  min-height: 100vh;
  color: var(--cream);
  overflow-x: hidden;
}
body::before {
  content: '';
  position: fixed; inset: 0;
  background:
    radial-gradient(ellipse at 20% 10%, rgba(244,192,75,0.08) 0%, transparent 50%),
    radial-gradient(ellipse at 80% 90%, rgba(212,33,61,0.08) 0%, transparent 50%);
  pointer-events: none; z-index: 0;
}
.app {
  position: relative; z-index: 1;
  max-width: 480px; margin: 0 auto; padding: 0 0 20px;
}

/* HEADER */
.header {
  text-align: center;
  padding: 28px 20px 20px;
  border-bottom: 1px solid rgba(244,192,75,0.2);
}
.header-badge {
  display: inline-block;
  background: var(--gold);
  color: var(--navy);
  font-size: 9px; font-weight: 600;
  letter-spacing: 3px; text-transform: uppercase;
  padding: 4px 12px; border-radius: 20px; margin-bottom: 8px;
}
.header h1 {
  font-family: 'Playfair Display', serif;
  font-size: 26px; font-weight: 900;
  color: var(--gold); line-height: 1.1;
}
.header h1 span { color: var(--cream); }
.castle-icon { font-size: 26px; margin-bottom: 4px; display: block; }

/* SETUP */
#setup-screen { padding: 24px 16px; }
.setup-card {
  background: rgba(255,255,255,0.04);
  border: 1px solid rgba(244,192,75,0.25);
  border-radius: 16px; padding: 24px; margin-bottom: 16px;
}
.setup-card h2 {
  font-family: 'Playfair Display', serif;
  font-size: 20px; color: var(--gold); margin-bottom: 6px;
}
.setup-card p {
  font-size: 13px; color: rgba(255,255,255,0.55);
  margin-bottom: 18px; line-height: 1.5;
}
.input-group { margin-bottom: 12px; }
.input-group label {
  display: block; font-size: 11px; font-weight: 600;
  letter-spacing: 1.5px; text-transform: uppercase;
  color: var(--gold); margin-bottom: 6px;
}
.input-group input {
  width: 100%;
  background: rgba(255,255,255,0.07);
  border: 1px solid rgba(244,192,75,0.3);
  border-radius: 10px; padding: 12px 14px;
  color: var(--cream); font-size: 15px;
  font-family: 'DM Sans', sans-serif;
  outline: none; transition: border-color 0.2s;
  -webkit-appearance: none; appearance: none;
}
.input-group input:focus { border-color: var(--gold); }
.input-group input::placeholder { color: rgba(255,255,255,0.25); }
.input-sm { padding: 10px 12px; font-size: 14px; }

.btn {
  display: block; width: 100%; padding: 14px;
  border: none; border-radius: 12px;
  font-family: 'DM Sans', sans-serif;
  font-size: 15px; font-weight: 600;
  cursor: pointer; letter-spacing: 0.3px;
  -webkit-appearance: none; appearance: none;
  transition: opacity 0.15s;
}
.btn:active { opacity: 0.8; }
.btn-primary {
  background: linear-gradient(135deg, var(--gold), var(--gold-dark));
  color: var(--navy);
}
.btn-secondary {
  background: rgba(255,255,255,0.08);
  color: var(--cream);
  border: 1px solid rgba(255,255,255,0.15);
  margin-top: 10px;
}

.divider {
  text-align: center; color: rgba(255,255,255,0.25);
  font-size: 12px; margin: 16px 0; letter-spacing: 2px;
}

.room-code-box {
  background: rgba(244,192,75,0.1);
  border: 2px dashed var(--gold);
  border-radius: 12px; padding: 16px;
  text-align: center; margin-top: 14px;
}
.room-code-box .code {
  font-family: 'Playfair Display', serif;
  font-size: 34px; font-weight: 900;
  color: var(--gold); letter-spacing: 8px;
}
.room-code-box .sublabel {
  font-size: 10px; letter-spacing: 2px;
  text-transform: uppercase; color: rgba(255,255,255,0.4); margin-top: 4px;
}

/* GAME */
#game-screen { display: none; }

.scoreboard {
  background: rgba(255,255,255,0.03);
  border-bottom: 1px solid rgba(244,192,75,0.15);
  padding: 14px 14px 12px;
}
.scoreboard-title {
  font-size: 9px; letter-spacing: 2.5px;
  text-transform: uppercase; color: rgba(255,255,255,0.35); margin-bottom: 10px;
}
.players-list { display: flex; flex-wrap: wrap; gap: 8px; }
.player-card {
  flex: 1; min-width: 80px;
  background: rgba(255,255,255,0.05);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 10px; padding: 8px 10px;
  text-align: center; transition: all 0.4s;
}
.player-card.is-me { border-color: rgba(244,192,75,0.5); background: rgba(244,192,75,0.08); }
.player-card.leading { border-color: var(--gold); background: rgba(244,192,75,0.12); box-shadow: 0 0 12px rgba(244,192,75,0.15); }
.pc-name { font-size: 11px; font-weight: 600; color: rgba(255,255,255,0.7); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.pc-pts { font-family: 'Playfair Display', serif; font-size: 22px; color: var(--gold); line-height: 1; }
.pc-stamps { font-size: 10px; color: rgba(255,255,255,0.35); }

.my-stats { display: flex; border-bottom: 1px solid rgba(244,192,75,0.12); }
.stat-box { flex: 1; padding: 12px 8px; text-align: center; border-right: 1px solid rgba(255,255,255,0.06); }
.stat-box:last-child { border-right: none; }
.stat-val { font-family: 'Playfair Display', serif; font-size: 24px; color: var(--gold); }
.stat-label { font-size: 9px; letter-spacing: 1.2px; text-transform: uppercase; color: rgba(255,255,255,0.35); margin-top: 2px; }

.add-section { padding: 16px 14px 10px; }
.section-title { font-family: 'Playfair Display', serif; font-size: 16px; color: var(--gold); margin-bottom: 14px; }
.form-row { display: flex; gap: 10px; margin-bottom: 10px; }
.form-row .input-group { flex: 1; margin-bottom: 0; }
.point-hint { font-size: 11px; color: rgba(255,255,255,0.35); margin-bottom: 12px; line-height: 1.6; }
.point-hint span { color: var(--gold); font-weight: 600; }

.stamps-section { padding: 6px 14px 16px; }
.stamps-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }

.stamp {
  border-radius: 10px;
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  padding: 8px 6px; text-align: center;
  position: relative; overflow: hidden; min-height: 90px;
  animation: stampIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
}
@keyframes stampIn {
  from { opacity: 0; transform: scale(0.5) rotate(-8deg); }
  to   { opacity: 1; transform: scale(1)   rotate(0deg);  }
}
.stamp::before {
  content: ''; position: absolute; inset: 3px;
  border: 1.5px dashed rgba(255,255,255,0.3);
  border-radius: 7px; pointer-events: none;
}
.s-near   { background: linear-gradient(135deg, #2D6A4F, #1A4030); }
.s-mid    { background: linear-gradient(135deg, #8A5A1B, #5E3A0D); }
.s-far    { background: linear-gradient(135deg, #5B2D8A, #3A1A5E); }
.s-intl   { background: linear-gradient(135deg, #1B4F8A, #0D3060); }
.s-mickey { background: linear-gradient(135deg, #8B1A1A, #4A0A0A); border: 2px solid var(--gold); }
.s-mickey::before { border-color: rgba(244,192,75,0.6); }

.stamp-pts  { position: absolute; top: 5px; right: 6px; font-size: 8px; font-weight: 700; color: var(--gold); }
.stamp-flag { font-size: 20px; margin-bottom: 2px; }
.stamp-name { font-size: 9px; font-weight: 600; color: rgba(255,255,255,0.9); line-height: 1.2; }
.stamp-loc  { font-size: 8px; color: rgba(255,255,255,0.5); margin-top: 1px; }
.stamp-dist { font-size: 8px; color: rgba(255,255,255,0.4); margin-top: 1px; }

.empty-stamps {
  grid-column: 1 / -1; text-align: center;
  padding: 36px 20px; color: rgba(255,255,255,0.2); font-size: 13px;
}
.empty-big { font-size: 38px; display: block; margin-bottom: 10px; }

/* GAME FOOTER - sits inline at the bottom of the game screen.
   NOT position:fixed so Safari's browser toolbar can never cover it. */
.game-footer {
  display: flex;
  gap: 8px;
  padding: 16px 14px 40px;
  border-top: 1px solid rgba(244,192,75,0.15);
  margin-top: 8px;
  align-items: center;
}
.room-pill {
  background: rgba(255,255,255,0.06);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 8px; padding: 10px;
  font-size: 11px; color: rgba(255,255,255,0.4); white-space: nowrap;
  display: flex; align-items: center;
}
.room-pill span { color: var(--gold); font-weight: 700; letter-spacing: 1px; }

/* TOAST */
.toast {
  position: fixed; bottom: 92px; left: 50%;
  transform: translateX(-50%) translateY(16px);
  background: var(--navy-light);
  border: 1px solid var(--gold);
  border-radius: 12px; padding: 12px 20px;
  font-size: 13px; font-weight: 500; color: var(--cream);
  opacity: 0; transition: all 0.3s; z-index: 100;
  white-space: nowrap; pointer-events: none;
}
.toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

/* MICKEY OVERLAY */
.mickey-blast {
  position: fixed; inset: 0;
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  background: rgba(10,5,30,0.93);
  z-index: 200; opacity: 0; pointer-events: none; transition: opacity 0.3s;
}
.mickey-blast.show { opacity: 1; pointer-events: all; }
.mb-ears { font-size: 80px; animation: mickeySpin 0.6s ease-out; }
.mb-title {
  font-family: 'Playfair Display', serif;
  font-size: 34px; color: var(--gold);
  text-shadow: 0 0 30px rgba(244,192,75,0.8); margin: 10px 0 4px;
}
.mb-sub { font-size: 15px; color: var(--cream); opacity: 0.8; }
.mb-pts {
  font-family: 'Playfair Display', serif;
  font-size: 60px; font-weight: 900; color: var(--gold);
  text-shadow: 0 0 40px rgba(244,192,75,0.9);
}
.mb-tap { font-size: 12px; color: rgba(255,255,255,0.35); margin-top: 20px; letter-spacing: 2px; text-transform: uppercase; }
@keyframes mickeySpin {
  from { transform: rotate(-30deg) scale(0); }
  to   { transform: rotate(0deg) scale(1); }
}

.btn-end {
  background: linear-gradient(135deg, #D4213D, #8B1A1A);
  color: var(--cream);
}

/* MODAL */
.modal-overlay {
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.7);
  display: flex; align-items: center; justify-content: center;
  z-index: 300; opacity: 0; pointer-events: none; transition: opacity 0.2s;
}
.modal-overlay.show { opacity: 1; pointer-events: all; }
.modal-box {
  background: var(--navy-light);
  border: 1px solid rgba(244,192,75,0.4);
  border-radius: 18px; padding: 28px 24px;
  max-width: 320px; width: 90%; text-align: center;
}
.modal-title { font-family: 'Playfair Display', serif; font-size: 20px; color: var(--gold); margin-bottom: 10px; }
.modal-msg   { font-size: 13px; color: rgba(255,255,255,0.6); margin-bottom: 20px; line-height: 1.5; }
.modal-btns  { display: flex; gap: 10px; }
.modal-btns .btn { flex: 1; padding: 12px; font-size: 14px; }

/* EDIT STAMP DRAWER */
.edit-overlay {
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.6);
  z-index: 350; opacity: 0; pointer-events: none;
  transition: opacity 0.25s;
  display: flex; align-items: flex-end; justify-content: center;
}
.edit-overlay.show { opacity: 1; pointer-events: all; }
.edit-drawer {
  background: var(--navy-light);
  border: 1px solid rgba(244,192,75,0.3);
  border-bottom: none;
  border-radius: 20px 20px 0 0;
  padding: 20px 20px 40px;
  width: 100%; max-width: 480px;
  transform: translateY(100%);
  transition: transform 0.3s cubic-bezier(0.32, 0.72, 0, 1);
}
.edit-overlay.show .edit-drawer { transform: translateY(0); }
.edit-drawer-handle {
  width: 40px; height: 4px;
  background: rgba(255,255,255,0.2);
  border-radius: 2px; margin: 0 auto 18px;
}
.edit-drawer-title {
  font-family: 'Playfair Display', serif;
  font-size: 18px; color: var(--gold); margin-bottom: 16px; text-align: center;
}
.edit-drawer-actions {
  display: flex; gap: 8px; margin-top: 14px;
}
.edit-drawer-actions .btn { flex: 1; margin: 0; padding: 13px; font-size: 14px; }
.btn-danger {
  background: rgba(212,33,61,0.15);
  color: #ff8fa0;
  border: 1px solid rgba(212,33,61,0.4);
}

/* Tap indicator on stamps */
.stamp { cursor: pointer; }
.stamp:active { opacity: 0.75; }

/* RETURNING PLAYER BANNER */
.rejoin-banner {
  background: rgba(244,192,75,0.08);
  border: 1px solid rgba(244,192,75,0.35);
  border-radius: 12px; padding: 16px;
  margin-bottom: 16px;
}
.rejoin-banner .rj-title { font-family: 'Playfair Display', serif; font-size: 18px; color: var(--gold); margin-bottom: 4px; text-align: center; }
.rejoin-banner .rj-sub   { font-size: 11px; letter-spacing: 1.5px; text-transform: uppercase; color: rgba(255,255,255,0.35); margin-bottom: 12px; text-align: center; }
.rejoin-list { display: flex; flex-direction: column; gap: 8px; margin-bottom: 4px; }
.rejoin-card {
  background: rgba(255,255,255,0.05);
  border: 1px solid rgba(244,192,75,0.2);
  border-radius: 10px; padding: 12px 14px;
  display: flex; align-items: center; gap: 10px;
}
.rejoin-card .rc-info { flex: 1; min-width: 0; }
.rejoin-card .rc-room { font-size: 10px; letter-spacing: 1.5px; text-transform: uppercase; color: rgba(255,255,255,0.4); }
.rejoin-card .rc-room strong { color: var(--gold); }
.rejoin-card .rc-name { font-weight: 600; font-size: 15px; color: var(--cream); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.rejoin-card .rc-stats { font-size: 11px; color: rgba(255,255,255,0.4); margin-top: 1px; }
.rejoin-card .rc-btn  { margin: 0; padding: 10px 16px; font-size: 13px; width: auto; flex-shrink: 0; }

/* DEVICE ID */
.device-id-box {
  margin-top: 12px;
  background: rgba(255,255,255,0.03);
  border: 1px solid rgba(255,255,255,0.08);
  border-radius: 8px; padding: 8px 12px;
  font-size: 10px; color: rgba(255,255,255,0.25);
  word-break: break-all; line-height: 1.6;
}
.device-id-box span { color: rgba(255,255,255,0.45); font-family: monospace; font-size: 10px; }

/* WINNER SCREEN */
.winner-screen {
  position: fixed; inset: 0;
  background: var(--navy);
  display: flex; align-items: center; justify-content: center;
  z-index: 400; opacity: 0; pointer-events: none; transition: opacity 0.4s;
  overflow-y: auto;
}
.winner-screen.show { opacity: 1; pointer-events: all; }
.winner-inner { text-align: center; padding: 40px 24px; max-width: 400px; width: 100%; }
.winner-trophy { font-size: 80px; animation: mickeySpin 0.6s ease-out; }
.winner-label  { font-size: 12px; letter-spacing: 3px; text-transform: uppercase; color: rgba(255,255,255,0.4); margin: 10px 0 4px; }
.winner-name   { font-family: 'Playfair Display', serif; font-size: 36px; color: var(--gold); text-shadow: 0 0 30px rgba(244,192,75,0.5); }
.winner-pts    { font-size: 14px; color: rgba(255,255,255,0.5); margin-top: 4px; margin-bottom: 24px; }
.winner-board  { display: flex; flex-direction: column; gap: 8px; margin-bottom: 8px; }
.wb-row {
  display: flex; align-items: center; justify-content: space-between;
  background: rgba(255,255,255,0.05); border-radius: 10px; padding: 10px 14px;
  border: 1px solid rgba(255,255,255,0.08);
}
.wb-row.first { border-color: var(--gold); background: rgba(244,192,75,0.1); }
.wb-rank { font-size: 16px; width: 28px; text-align: left; }
.wb-name { flex: 1; text-align: left; font-size: 14px; font-weight: 600; color: rgba(255,255,255,0.8); }
.wb-score{ font-family: 'Playfair Display', serif; font-size: 20px; color: var(--gold); }
  background: rgba(244,192,75,0.08);
  border: 1px solid rgba(244,192,75,0.25);
  border-radius: 10px; padding: 12px 14px;
  font-size: 12px; color: rgba(255,255,255,0.6);
  margin-bottom: 14px; line-height: 1.5;
}
.status-box.error {
  background: rgba(212,33,61,0.1);
  border-color: rgba(212,33,61,0.35);
  color: #ff8fa0;
}
</style>

</head>
<body>

<div class="app">

  <div class="header">
    <span class="castle-icon">&#127984;</span>
    <div class="header-badge">Walt Disney World</div>
    <h1>Passport <span>Collector</span></h1>
  </div>

  <!-- SETUP -->

  <div id="setup-screen">
    <div style="height:16px;"></div>

<div id="status-box" class="status-box" style="margin:0 0 16px;">
  Connecting to Firebase...
</div>

<!-- Rejoin banner - shown when Firebase finds active games for this device -->
<div class="rejoin-banner" id="rejoin-banner" style="display:none;">
  <div class="rj-title">Welcome back!</div>
  <div class="rj-sub">Your active games</div>
  <div id="rejoin-list" class="rejoin-list"></div>
  <button class="btn btn-secondary" id="btn-new-instead" type="button" style="margin-top:10px; font-size:13px;">Start / Join a Different Game</button>
</div>

<!-- Device ID shown small at bottom so user can copy it into Firebase console to recover old sessions -->
<div class="device-id-box">
  Device ID: <span id="device-id-display"></span><br>
  Tip: paste this into your player node in Firebase Realtime DB as the <strong style="color:rgba(255,255,255,0.4)">deviceId</strong> field to recover a lost session.
</div>

<div class="setup-card">
  <h2>Create a Game</h2>
  <p>Start a new room and share the code with other phones.</p>
  <div class="input-group">
    <label>Your Team Name</label>
    <input type="text" id="create-name" placeholder="e.g. Team Mickey"
      maxlength="20" autocomplete="off" autocorrect="off" spellcheck="false">
  </div>
  <button class="btn btn-primary" id="btn-create" type="button">Create New Game</button>
  <div id="room-created" style="display:none; margin-top:16px;">
    <div class="room-code-box">
      <div class="code" id="display-code"></div>
      <div class="sublabel">Share this code with other phones</div>
    </div>
    <button class="btn btn-primary" id="btn-enter" type="button" style="margin-top:14px;">Enter Game</button>
  </div>
</div>

<div class="divider">- or -</div>

<div class="setup-card">
  <h2>Join a Game</h2>
  <p>Got a room code? Enter it to join an existing game.</p>
  <div class="input-group">
    <label>Your Team Name</label>
    <input type="text" id="join-name" placeholder="e.g. Team Minnie"
      maxlength="20" autocomplete="off" autocorrect="off" spellcheck="false">
  </div>
  <div class="input-group">
    <label>Room Code</label>
    <input type="text" id="join-code" placeholder="e.g. CASTLE"
      maxlength="8" autocomplete="off" autocorrect="off" autocapitalize="characters"
      spellcheck="false" style="letter-spacing:4px; font-size:18px;">
  </div>
  <button class="btn btn-primary" id="btn-join" type="button">Join Game</button>
</div>

  </div>

  <!-- GAME -->

  <div id="game-screen">

<div class="scoreboard">
  <div class="scoreboard-title">Leaderboard</div>
  <div class="players-list" id="players-list">
    <div style="color:rgba(255,255,255,0.3); font-size:13px; padding:4px;">Loading...</div>
  </div>
</div>

<div class="my-stats">
  <div class="stat-box"><div class="stat-val" id="my-points">0</div><div class="stat-label">Points</div></div>
  <div class="stat-box"><div class="stat-val" id="my-stamps">0</div><div class="stat-label">Stamps</div></div>
  <div class="stat-box"><div class="stat-val" id="my-countries">0</div><div class="stat-label">Countries</div></div>
  <div class="stat-box"><div class="stat-val" id="my-states">0</div><div class="stat-label">US States</div></div>
</div>

<div class="add-section">
  <div class="section-title">Stamp a New Passport</div>
  <div class="input-group">
    <label>Person's First Name</label>
    <input type="text" id="person-name" class="input-sm"
      placeholder="e.g. Sarah" maxlength="20"
      autocomplete="off" autocorrect="off" spellcheck="false">
  </div>
  <div class="form-row">
    <div class="input-group">
      <label>Country</label>
      <input type="text" id="person-country" class="input-sm"
        placeholder="e.g. France" maxlength="30"
        autocomplete="off" autocorrect="off" spellcheck="false">
    </div>
    <div class="input-group">
      <label>US State (if USA)</label>
      <input type="text" id="person-state" class="input-sm"
        placeholder="e.g. Texas" maxlength="20"
        autocomplete="off" autocorrect="off" spellcheck="false">
    </div>
  </div>
  <div class="point-hint">
    Points = distance from Walt Disney World!<br>
    Nearby FL = <span>1-5 pts</span> &nbsp;|&nbsp; Far US state = <span>20-30 pts</span><br>
    International = <span>50-500 pts</span> &nbsp;|&nbsp; Disney name = <span>+50 BONUS!</span>
  </div>
  <button class="btn btn-primary" id="btn-stamp" type="button">Add Stamp!</button>
</div>

<div class="stamps-section">
  <div class="section-title">My Collection</div>
  <div class="stamps-grid" id="stamps-grid">
    <div class="empty-stamps">
      <span class="empty-big">&#9992;&#65039;</span>
      Ask someone where they are from to earn your first stamp!
    </div>
  </div>
</div>

<!-- Footer inline - Safari toolbar can never cover it -->
<div class="game-footer" id="game-footer" style="display:none;">
  <div class="room-pill">Room: <span id="bar-code"></span></div>
  <div class="room-pill">You: <span id="bar-name" style="color:var(--cream);"></span></div>
  <button class="btn btn-secondary" id="btn-leave" type="button"
    style="margin:0; padding:12px 14px; font-size:13px; flex:1; min-height:44px;">Leave</button>
  <button class="btn btn-end" id="btn-end" type="button"
    style="margin:0; padding:12px 14px; font-size:13px; flex:1; min-height:44px; display:none;">End Game</button>
</div>

  </div>
</div>

<!-- Reconciliation overlay (keep score vs reset) - separate from main modal -->

<div class="modal-overlay" id="reconcile-overlay">
  <div class="modal-box">
    <div class="modal-title">Stamp records missing</div>
    <div class="modal-msg">
      Your score (<span id="reconcile-pts"></span>) is saved but individual stamp
      details weren't recorded in this version. Keep your score and re-add stamps
      manually, or reset to zero and start fresh?
    </div>
    <div class="modal-btns" style="flex-direction:column; gap:8px;">
      <button class="btn btn-primary"   id="reconcile-keep"  type="button" style="margin:0;">Keep My Score</button>
      <button class="btn btn-danger"    id="reconcile-reset" type="button" style="margin:0;">Reset to Zero</button>
    </div>
  </div>
</div>

<!-- Custom confirm modal -->

<div class="modal-overlay" id="modal-overlay">
  <div class="modal-box">
    <div class="modal-title" id="modal-title">Leave game?</div>
    <div class="modal-msg" id="modal-msg">Your stamps will be saved but you will need the room code to rejoin.</div>
    <div class="modal-btns">
      <button class="btn btn-secondary" id="modal-cancel" type="button" style="margin:0;">Cancel</button>
      <button class="btn btn-primary"   id="modal-ok"     type="button" style="margin:0;">Yes, leave</button>
    </div>
  </div>
</div>

<!-- Edit stamp drawer -->

<div class="edit-overlay" id="edit-overlay">
  <div class="edit-drawer">
    <div class="edit-drawer-handle"></div>
    <div class="edit-drawer-title">Edit Stamp</div>
    <div class="input-group">
      <label>Person's First Name</label>
      <input type="text" id="edit-name" class="input-sm"
        maxlength="20" autocomplete="off" autocorrect="off" spellcheck="false">
    </div>
    <div class="form-row">
      <div class="input-group">
        <label>Country</label>
        <input type="text" id="edit-country" class="input-sm"
          maxlength="30" autocomplete="off" autocorrect="off" spellcheck="false">
      </div>
      <div class="input-group">
        <label>US State (if USA)</label>
        <input type="text" id="edit-state" class="input-sm"
          maxlength="20" autocomplete="off" autocorrect="off" spellcheck="false">
      </div>
    </div>
    <div class="edit-drawer-actions">
      <button class="btn btn-danger"    id="edit-delete" type="button">Delete</button>
      <button class="btn btn-secondary" id="edit-cancel" type="button">Cancel</button>
      <button class="btn btn-primary"   id="edit-save"   type="button">Save</button>
    </div>
  </div>
</div>

<!-- Winner screen -->

<div class="winner-screen" id="winner-screen">
  <div class="winner-inner">
    <div class="winner-trophy">&#127942;</div>
    <div class="winner-label">Game Over!</div>
    <div class="winner-name" id="winner-name"></div>
    <div class="winner-pts"  id="winner-pts"></div>
    <div class="winner-board" id="winner-board"></div>
    <button class="btn btn-primary" id="btn-new-game" type="button" style="margin-top:24px;">Play Again</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<div class="mickey-blast" id="mickey-blast">
  <div class="mb-ears">&#128045;</div>
  <div class="mb-title">MICKEY BONUS!</div>
  <div class="mb-sub" id="mb-name-display"></div>
  <div class="mb-pts" id="mb-pts-display"></div>
  <div class="mb-tap">tap to continue</div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAh-GBElMhJbXGftr9IUTHmk4LYAlkAPfE",
  authDomain: "disney-world-passport-game.firebaseapp.com",
  databaseURL: "https://disney-world-passport-game-default-rtdb.firebaseio.com",
  projectId: "disney-world-passport-game",
  storageBucket: "disney-world-passport-game.firebasestorage.app",
  messagingSenderId: "134143307824",
  appId: "1:134143307824:web:a12ede396c472decce7df5"
};

var db        = null;
var myName    = "";
var myId      = null;
var roomCode  = "";
var myStamps  = [];
var amCreator = false;
var modalOkFn = null;

var WDW_LAT      = 28.3772;
var WDW_LNG      = -81.5707;
var MICKEY_BONUS = 50;

var MICKEY_NAMES = [
  "mickey","minnie","walt","donald","goofy","pluto","daisy",
  "chip","dale","buzz","woody","elsa","anna","moana","ariel",
  "belle","jasmine","mulan","tiana","rapunzel","aurora","cinderella","snow"
];
var ROOM_WORDS = [
  "CASTLE","MICKEY","MAGIC","EPCOT","PIXAR","SPLASH",
  "NEMO","ELSA","GOOFY","WOODY","BUZZ","BELLE"
];

var STATE_COORDS = {
  "alabama":      [32.8, -86.8],  "alaska":             [64.2,-153.4],
  "arizona":      [34.3,-111.1],  "arkansas":           [34.8, -92.2],
  "california":   [36.8,-119.4],  "colorado":           [39.0,-105.5],
  "connecticut":  [41.6, -72.7],  "delaware":           [38.9, -75.5],
  "florida":      [27.8, -81.6],  "georgia":            [32.2, -83.4],
  "hawaii":       [20.3,-156.3],  "idaho":              [44.4,-114.6],
  "illinois":     [40.0, -89.2],  "indiana":            [39.9, -86.3],
  "iowa":         [42.0, -93.5],  "kansas":             [38.5, -98.4],
  "kentucky":     [37.7, -84.9],  "louisiana":          [31.2, -91.8],
  "maine":        [45.4, -69.0],  "maryland":           [39.1, -76.8],
  "massachusetts":[42.3, -71.8],  "michigan":           [44.3, -85.4],
  "minnesota":    [46.4, -93.1],  "mississippi":        [32.7, -89.7],
  "missouri":     [38.4, -92.5],  "montana":            [47.0,-109.6],
  "nebraska":     [41.5, -99.9],  "nevada":             [38.5,-117.2],
  "new hampshire":[43.7, -71.6],  "new jersey":         [40.1, -74.5],
  "new mexico":   [34.5,-106.2],  "new york":           [42.9, -75.5],
  "north carolina":[35.6,-79.8],  "north dakota":       [47.5,-100.5],
  "ohio":         [40.4, -82.8],  "oklahoma":           [35.6, -96.9],
  "oregon":       [43.9,-120.6],  "pennsylvania":       [40.6, -77.2],
  "rhode island": [41.7, -71.5],  "south carolina":     [33.9, -80.9],
  "south dakota": [44.4,-100.2],  "tennessee":          [35.9, -86.7],
  "texas":        [31.1, -97.6],  "utah":               [39.3,-111.1],
  "vermont":      [44.0, -72.7],  "virginia":           [37.8, -78.2],
  "washington":   [47.4,-120.5],  "west virginia":      [38.6, -80.6],
  "wisconsin":    [44.3, -89.6],  "wyoming":            [43.0,-107.6],
  "dc":                    [38.9,-77.0],
  "district of columbia":  [38.9,-77.0],
  "puerto rico":           [18.2,-66.6],
  "guam":                  [13.4,144.8],
  "us virgin islands":     [18.3,-64.9],
  "american samoa":        [-14.3,-170.7],
  "northern mariana islands":[15.1,145.7]
};

var COUNTRY_COORDS = {
  "canada":               [56.1,-106.3], "mexico":               [23.6,-102.6],
  "uk":                   [55.4,  -3.4], "united kingdom":       [55.4,  -3.4],
  "great britain":        [55.4,  -3.4], "england":              [52.4,  -1.9],
  "scotland":             [56.8,  -4.2], "wales":                [52.3,  -3.8],
  "ireland":              [53.4,  -8.2], "australia":           [-25.3, 133.8],
  "new zealand":         [-40.9, 174.9], "japan":                [36.2, 138.3],
  "china":                [35.9, 104.2], "india":                [20.6,  78.9],
  "brazil":              [-14.2, -51.9], "france":               [46.2,   2.2],
  "germany":              [51.2,  10.4], "italy":                [41.9,  12.6],
  "spain":                [40.5,  -3.7], "portugal":             [39.4,  -8.2],
  "netherlands":          [52.1,   5.3], "belgium":              [50.5,   4.5],
  "switzerland":          [46.8,   8.2], "austria":              [47.5,  14.6],
  "sweden":               [60.1,  18.6], "norway":               [64.6,  17.9],
  "denmark":              [56.3,   9.5], "finland":              [61.9,  25.7],
  "poland":               [51.9,  19.1], "ukraine":              [48.4,  31.2],
  "czech republic":       [49.8,  15.5], "hungary":              [47.2,  19.5],
  "romania":              [45.9,  24.9], "greece":               [39.1,  22.0],
  "turkey":               [38.9,  35.2], "russia":               [61.5, 105.3],
  "israel":               [31.0,  34.9], "saudi arabia":         [23.9,  45.1],
  "uae":                  [23.4,  53.8], "united arab emirates": [23.4,  53.8],
  "egypt":                [26.8,  30.8], "south africa":        [-30.6,  22.9],
  "nigeria":               [9.1,   8.7], "kenya":                 [0.0,  37.9],
  "argentina":           [-38.4, -63.6], "colombia":              [4.6, -74.1],
  "chile":               [-35.7, -71.5], "peru":                 [-9.2, -75.0],
  "venezuela":             [6.4, -66.6], "south korea":          [35.9, 127.8],
  "indonesia":            [-0.8, 113.9], "philippines":          [12.9, 121.8],
  "vietnam":              [14.1, 108.3], "thailand":             [15.9, 100.9],
  "malaysia":              [4.2, 109.5], "singapore":             [1.3, 103.8],
  "bangladesh":           [23.7,  90.4], "pakistan":             [30.4,  69.3],
  "iran":                 [32.4,  53.7], "iraq":                 [33.2,  43.7],
  "morocco":              [31.8,  -7.1], "ethiopia":              [9.1,  40.5],
  "ghana":                 [7.9,  -1.0], "cuba":                 [21.5, -79.5],
  "jamaica":              [18.1, -77.3], "haiti":                [18.9, -72.7],
  "dominican republic":   [18.7, -70.2], "bahamas":              [25.0, -77.4],
  "barbados":             [13.2, -59.6], "costa rica":            [9.7, -83.8],
  "panama":                [8.5, -80.8], "guatemala":            [15.8, -90.2],
  "honduras":             [15.2, -86.2], "el salvador":          [13.8, -88.9],
  "nicaragua":            [12.9, -85.2], "trinidad":             [10.7, -61.2]
};

var FLAGS = {
  "canada":"CA","mexico":"MX","uk":"GB","united kingdom":"GB",
  "great britain":"GB","england":"GB","scotland":"GB","wales":"GB",
  "ireland":"IE","australia":"AU","new zealand":"NZ","japan":"JP",
  "china":"CN","india":"IN","brazil":"BR","france":"FR","germany":"DE",
  "italy":"IT","spain":"ES","portugal":"PT","netherlands":"NL",
  "belgium":"BE","switzerland":"CH","austria":"AT","sweden":"SE",
  "norway":"NO","denmark":"DK","finland":"FI","poland":"PL",
  "ukraine":"UA","czech republic":"CZ","hungary":"HU","romania":"RO",
  "greece":"GR","turkey":"TR","russia":"RU","israel":"IL",
  "saudi arabia":"SA","uae":"AE","united arab emirates":"AE",
  "egypt":"EG","south africa":"ZA","nigeria":"NG","kenya":"KE",
  "south korea":"KR","indonesia":"ID","philippines":"PH","vietnam":"VN",
  "thailand":"TH","malaysia":"MY","singapore":"SG","cuba":"CU",
  "jamaica":"JM","argentina":"AR","colombia":"CO","chile":"CL",
  "peru":"PE","venezuela":"VE","costa rica":"CR","panama":"PA",
  "bahamas":"BS","barbados":"BB"
};

// ---- SESSION STORAGE ----
function saveSession() {
  try {
    localStorage.setItem("passport_session", JSON.stringify({
      myId:     myId,
      myName:   myName,
      roomCode: roomCode,
      myStamps: myStamps,
      amCreator: amCreator
    }));
  } catch(e) {}
}

function clearSession() {
  try { localStorage.removeItem("passport_session"); } catch(e) {}
}

function loadSession() {
  try {
    var raw = localStorage.getItem("passport_session");
    if (!raw) { return null; }
    return JSON.parse(raw);
  } catch(e) { return null; }
}

// ---- MODAL (replaces window.confirm) ----
function showModal(title, msg, okLabel, onOk) {
  document.getElementById("modal-title").textContent  = title;
  document.getElementById("modal-msg").textContent    = msg;
  document.getElementById("modal-ok").textContent     = okLabel;
  modalOkFn = onOk;
  document.getElementById("modal-overlay").classList.add("show");
}

// ---- HELPERS ----
function showToast(msg) {
  var t = document.getElementById("toast");
  t.textContent = msg;
  t.classList.add("show");
  setTimeout(function() { t.classList.remove("show"); }, 2800);
}

function randomCode() {
  return ROOM_WORDS[Math.floor(Math.random() * ROOM_WORDS.length)];
}

function haversineKm(lat1, lng1, lat2, lng2) {
  var R    = 6371;
  var dLat = (lat2 - lat1) * Math.PI / 180;
  var dLng = (lng2 - lng1) * Math.PI / 180;
  var a    = Math.sin(dLat/2) * Math.sin(dLat/2) +
             Math.cos(lat1 * Math.PI/180) * Math.cos(lat2 * Math.PI/180) *
             Math.sin(dLng/2) * Math.sin(dLng/2);
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

function kmToMiles(km) { return Math.round(km * 0.621371); }

function distKmForStamp(stamp) {
  var c     = stamp.country.toLowerCase();
  var s     = (stamp.state || "").toLowerCase();
  var isUSA = (c === "usa" || c === "united states" || c === "us");
  if (isUSA && s && STATE_COORDS[s]) {
    var sc = STATE_COORDS[s];
    return haversineKm(WDW_LAT, WDW_LNG, sc[0], sc[1]);
  }
  if (!isUSA && COUNTRY_COORDS[c]) {
    var cc = COUNTRY_COORDS[c];
    return haversineKm(WDW_LAT, WDW_LNG, cc[0], cc[1]);
  }
  return isUSA ? 1000 : 5000;
}

function distPtsForKm(km)  { return Math.max(1, Math.round(km / 100)); }
function isMickeyName(name){ return MICKEY_NAMES.indexOf(name.toLowerCase().trim()) !== -1; }

function getFlag(stamp) {
  var c = stamp.country.toLowerCase();
  if (c === "usa" || c === "united states" || c === "us") { return "US"; }
  return FLAGS[c] || null;
}

function flagEmoji(code) {
  if (!code) { return ""; }
  var result = "";
  for (var i = 0; i < code.length; i++) {
    result += String.fromCodePoint(code.charCodeAt(i) - 65 + 0x1F1E6);
  }
  return result;
}

function stampClass(km) {
  if (km < 500)  { return "s-near"; }
  if (km < 2500) { return "s-mid";  }
  if (km < 6000) { return "s-far";  }
  return "s-intl";
}

function distLabel(km) {
  var m = kmToMiles(km);
  if (m < 100) { return m + " mi away"; }
  return m.toLocaleString() + " mi";
}

function recalcTotals() {
  var totalPts = 0, countries = 0, states = 0;
  for (var i = 0; i < myStamps.length; i++) {
    var s  = myStamps[i];
    totalPts += s.pts;
    var c  = s.country.toLowerCase();
    var ok = (c === "usa" || c === "united states" || c === "us");
    if (!ok) { countries++; }
    else if (s.state) { states++; }
  }
  return { totalPts: totalPts, countries: countries, states: states };
}

function showMickeyBlast(name, pts) {
  document.getElementById("mb-name-display").textContent = name + " triggered the bonus!";
  document.getElementById("mb-pts-display").textContent  = "+" + pts + " pts";
  document.getElementById("mickey-blast").classList.add("show");
}

// ---- FIREBASE INIT ----
function initFirebase() {
  var statusBox = document.getElementById("status-box");
  try {
    firebase.initializeApp(firebaseConfig);
    db = firebase.database();
    db.ref(".info/connected").on("value", function(snap) {
      if (snap.val() === true) {
        statusBox.textContent = "Connected! Ready to play.";
        statusBox.className   = "status-box";
        setTimeout(function() { statusBox.style.display = "none"; }, 2000);
        checkForSavedSession();
      } else {
        statusBox.textContent = "Connecting to Firebase...";
        statusBox.className   = "status-box";
      }
    });
  } catch(e) {
    statusBox.textContent = "Firebase error: " + e.message;
    statusBox.className   = "status-box error";
  }
}

// ---- DEVICE ID ----
// A stable identifier stored in localStorage. Much lighter than full session --
// just an ID, so it survives PWA updates far better than game state does.
function getDeviceId() {
  try {
    var id = localStorage.getItem("passport_device_id");
    if (!id) {
      id = "dev_" + Math.random().toString(36).slice(2) + Math.random().toString(36).slice(2);
      localStorage.setItem("passport_device_id", id);
    }
    return id;
  } catch(e) {
    // localStorage blocked -- generate a session-only id
    if (!window._fallbackDeviceId) {
      window._fallbackDeviceId = "dev_" + Math.random().toString(36).slice(2);
    }
    return window._fallbackDeviceId;
  }
}

var deviceId = getDeviceId();

// ---- SESSION (lightweight local hint only) ----
function saveSession() {
  try {
    // Store minimal local hint -- the real source of truth is Firebase
    localStorage.setItem("passport_last_room", roomCode);
  } catch(e) {}
}

function clearSession() {
  try { localStorage.removeItem("passport_last_room"); } catch(e) {}
}

// ---- MODAL ----

function hideModal() {
  document.getElementById("modal-overlay").classList.remove("show");
  modalOkFn = null;
}

// ---- HELPERS ----
function showToast(msg) {
  var t = document.getElementById("toast");
  t.textContent = msg;
  t.classList.add("show");
  setTimeout(function() { t.classList.remove("show"); }, 2800);
}

function randomCode() {
  return ROOM_WORDS[Math.floor(Math.random() * ROOM_WORDS.length)];
}

function haversineKm(lat1, lng1, lat2, lng2) {
  var R    = 6371;
  var dLat = (lat2 - lat1) * Math.PI / 180;
  var dLng = (lng2 - lng1) * Math.PI / 180;
  var a    = Math.sin(dLat/2) * Math.sin(dLat/2) +
             Math.cos(lat1 * Math.PI/180) * Math.cos(lat2 * Math.PI/180) *
             Math.sin(dLng/2) * Math.sin(dLng/2);
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

function kmToMiles(km) { return Math.round(km * 0.621371); }

function distKmForStamp(stamp) {
  var c     = stamp.country.toLowerCase();
  var s     = (stamp.state || "").toLowerCase();
  var isUSA = (c === "usa" || c === "united states" || c === "us");
  if (isUSA && s && STATE_COORDS[s]) {
    var sc = STATE_COORDS[s];
    return haversineKm(WDW_LAT, WDW_LNG, sc[0], sc[1]);
  }
  if (!isUSA && COUNTRY_COORDS[c]) {
    var cc = COUNTRY_COORDS[c];
    return haversineKm(WDW_LAT, WDW_LNG, cc[0], cc[1]);
  }
  return isUSA ? 1000 : 5000;
}

function distPtsForKm(km)  { return Math.max(1, Math.round(km / 100)); }
function isMickeyName(name){ return MICKEY_NAMES.indexOf(name.toLowerCase().trim()) !== -1; }

function getFlag(stamp) {
  var c = stamp.country.toLowerCase();
  if (c === "usa" || c === "united states" || c === "us") { return "US"; }
  return FLAGS[c] || null;
}

function flagEmoji(code) {
  if (!code) { return ""; }
  var result = "";
  for (var i = 0; i < code.length; i++) {
    result += String.fromCodePoint(code.charCodeAt(i) - 65 + 0x1F1E6);
  }
  return result;
}

function stampClass(km) {
  if (km < 500)  { return "s-near"; }
  if (km < 2500) { return "s-mid";  }
  if (km < 6000) { return "s-far";  }
  return "s-intl";
}

function distLabel(km) {
  var m = kmToMiles(km);
  if (m < 100) { return m + " mi away"; }
  return m.toLocaleString() + " mi";
}

function recalcTotals() {
  var totalPts = 0, countries = 0, states = 0;
  for (var i = 0; i < myStamps.length; i++) {
    var s  = myStamps[i];
    totalPts += s.pts;
    var c  = s.country.toLowerCase();
    var ok = (c === "usa" || c === "united states" || c === "us");
    if (!ok) { countries++; }
    else if (s.state) { states++; }
  }
  return { totalPts: totalPts, countries: countries, states: states };
}

function showMickeyBlast(name, pts) {
  document.getElementById("mb-name-display").textContent = name + " triggered the bonus!";
  document.getElementById("mb-pts-display").textContent  = "+" + pts + " pts";
  document.getElementById("mickey-blast").classList.add("show");
}

// ---- FIREBASE INIT ----
function initFirebase() {
  var statusBox = document.getElementById("status-box");

  // Show device ID so user can paste it into Firebase console to recover a session
  var didEl = document.getElementById("device-id-display");
  if (didEl) { didEl.textContent = deviceId; }

  try {
    firebase.initializeApp(firebaseConfig);
    db = firebase.database();
    db.ref(".info/connected").on("value", function(snap) {
      if (snap.val() === true) {
        statusBox.textContent = "Connected! Searching for your games...";
        statusBox.className   = "status-box";
        findActiveGamesForDevice();
      } else {
        statusBox.textContent = "Connecting to Firebase...";
        statusBox.className   = "status-box";
      }
    });
  } catch(e) {
    statusBox.textContent = "Firebase error: " + e.message;
    statusBox.className   = "status-box error";
  }
}

// ---- FIND ALL ACTIVE GAMES FOR THIS DEVICE ----
// Scans every room in Firebase for a player whose deviceId matches ours.
// Fast path: checks lastRoom first, then scans all others in parallel.
function findActiveGamesForDevice() {
  var statusBox = document.getElementById("status-box");

  db.ref("rooms").once("value", function(snap) {
    if (!snap.exists()) {
      statusBox.textContent = "Connected! Ready to play.";
      setTimeout(function() { statusBox.style.display = "none"; }, 1500);
      return;
    }

    var allRooms = snap.val();
    var found    = []; // [{roomCode, playerId, playerData}]

    Object.keys(allRooms).forEach(function(code) {
      var room = allRooms[code];
      if (room.ended) { return; } // skip finished games
      if (!room.players) { return; }
      Object.keys(room.players).forEach(function(pid) {
        var p = room.players[pid];
        if (p.deviceId && p.deviceId === deviceId) {
          found.push({
            roomCode:   code,
            playerId:   pid,
            playerData: p
          });
        }
      });
    });

    statusBox.textContent = "Connected! Ready to play.";
    statusBox.className   = "status-box";
    setTimeout(function() { statusBox.style.display = "none"; }, 1500);

    if (found.length > 0) {
      showRejoinOptions(found, allRooms);
    }
  });
}

// ---- SHOW REJOIN OPTIONS ----
// Renders a card per active game the device is in.
function showRejoinOptions(found, allRooms) {
  var banner = document.getElementById("rejoin-banner");
  var list   = document.getElementById("rejoin-list");

  list.innerHTML = "";

  found.forEach(function(entry) {
    var room = allRooms[entry.roomCode];
    var pd   = entry.playerData;
    var stamps = pd.stamps  || 0;
    var pts    = pd.points  || 0;
    var name   = pd.name    || "Unknown";

    // Count players in room
    var playerCount = room.players ? Object.keys(room.players).length : 0;

    var card = document.createElement("div");
    card.className = "rejoin-card";
    card.innerHTML =
      "<div class='rc-info'>" +
        "<div class='rc-room'>Room: <strong>" + entry.roomCode + "</strong>" +
          " &nbsp;&#183;&nbsp; " + playerCount + " player" + (playerCount !== 1 ? "s" : "") + "</div>" +
        "<div class='rc-name'>" + name + "</div>" +
        "<div class='rc-stats'>" + pts + " pts &nbsp;&#183;&nbsp; " + stamps + " stamp" + (stamps !== 1 ? "s" : "") + "</div>" +
      "</div>" +
      "<button class='btn btn-primary rc-btn' type='button'>Rejoin</button>";

    card.querySelector(".rc-btn").addEventListener("click", function() {
      rejoinGame(entry, allRooms[entry.roomCode]);
    });

    list.appendChild(card);
  });

  banner.style.display = "block";

  document.getElementById("btn-new-instead").onclick = function() {
    banner.style.display = "none";
  };
}

// ---- REJOIN A SPECIFIC GAME ----
function rejoinGame(entry, roomData) {
  var pd        = entry.playerData;
  var savedPts  = pd.points      || 0;
  var savedData = pd.stamps_data || [];

  // No mismatch -- just go straight in
  if (savedPts === 0 || savedData.length > 0) {
    doRejoin(entry, pd, savedData);
    return;
  }

  // Points exist but no stamp records -- show reconciliation choice.
  // Use a dedicated two-button overlay instead of repurposing the modal.
  var overlay = document.getElementById("reconcile-overlay");
  document.getElementById("reconcile-pts").textContent = savedPts + " pts";
  overlay.classList.add("show");

  document.getElementById("reconcile-keep").onclick = function() {
    overlay.classList.remove("show");
    doRejoin(entry, pd, []);
  };

  document.getElementById("reconcile-reset").onclick = function() {
    overlay.classList.remove("show");
    db.ref("rooms/" + entry.roomCode + "/players/" + entry.playerId).update({
      points:      0,
      stamps:      0,
      countries:   0,
      states:      0,
      stamps_data: []
    }, function() {
      doRejoin(entry, pd, []);
    });
  };
}

function doRejoin(entry, pd, stampsData) {
  myId      = entry.playerId;
  myName    = pd.name      || "";
  roomCode  = entry.roomCode;
  amCreator = pd.amCreator || false;
  myStamps  = stampsData;

  document.getElementById("rejoin-banner").style.display = "none";
  saveSession();
  startGame();
}

// ---- ROOM FUNCTIONS ----
function createRoom() {
  if (!db) { showToast("Firebase not ready yet. Wait a moment."); return; }
  var name = document.getElementById("create-name").value.trim();
  if (!name) { showToast("Enter your team name first!"); return; }
  myName    = name;
  roomCode  = randomCode();
  amCreator = true;
  db.ref("rooms/" + roomCode).once("value", function(snap) {
    if (snap.exists()) { roomCode = randomCode() + Math.floor(Math.random() * 9); }
    document.getElementById("display-code").textContent   = roomCode;
    document.getElementById("room-created").style.display = "block";
  });
}

function enterGame() {
  if (!db) { return; }
  var name = document.getElementById("create-name").value.trim();
  if (!name) { return; }
  myName    = name;
  amCreator = true;
  var playerRef = db.ref("rooms/" + roomCode + "/players").push();
  myId = playerRef.key;
  playerRef.set({
    name:        myName,
    points:      0,
    stamps:      0,
    countries:   0,
    states:      0,
    deviceId:    deviceId,
    amCreator:   true,
    stamps_data: []
  }, function() {
    saveSession();
    startGame();
  });
}

function joinRoom() {
  if (!db) { showToast("Firebase not ready yet. Wait a moment."); return; }
  var name = document.getElementById("join-name").value.trim();
  var code = document.getElementById("join-code").value.trim().toUpperCase();
  if (!name) { showToast("Enter your team name!"); return; }
  if (!code) { showToast("Enter a room code!"); return; }
  db.ref("rooms/" + code).once("value", function(snap) {
    if (!snap.exists()) { showToast("Room not found! Check the code."); return; }
    if (snap.val().ended) { showToast("That game has already ended!"); return; }
    myName    = name;
    roomCode  = code;
    amCreator = false;
    var playerRef = db.ref("rooms/" + roomCode + "/players").push();
    myId = playerRef.key;
    playerRef.set({
      name:        myName,
      points:      0,
      stamps:      0,
      countries:   0,
      states:      0,
      deviceId:    deviceId,
      amCreator:   false,
      stamps_data: []
    }, function() {
      saveSession();
      startGame();
    });
  });
}

function startGame() {
  document.getElementById("setup-screen").style.display  = "none";
  document.getElementById("game-screen").style.display   = "block";
  document.getElementById("game-footer").style.display   = "flex";
  document.getElementById("bar-code").textContent = roomCode;
  document.getElementById("bar-name").textContent = myName;

  if (amCreator) {
    document.getElementById("btn-end").style.display = "block";
  }

  subscribeToPlayers();
  subscribeToGameState();

  if (myStamps.length > 0) {
    var totals = recalcTotals();
    document.getElementById("my-points").textContent    = totals.totalPts;
    document.getElementById("my-stamps").textContent    = myStamps.length;
    document.getElementById("my-countries").textContent = totals.countries;
    document.getElementById("my-states").textContent    = totals.states;
    renderMyStamps();
  }
}

function subscribeToPlayers() {
  db.ref("rooms/" + roomCode + "/players").on("value", function(snap) {
    renderPlayers(snap.val() || {});
  });
}

function subscribeToGameState() {
  db.ref("rooms/" + roomCode + "/ended").on("value", function(snap) {
    if (snap.val() === true) {
      db.ref("rooms/" + roomCode + "/players").once("value", function(psnap) {
        showWinnerScreen(psnap.val() || {});
      });
    }
  });
}

function renderPlayers(data) {
  var list = [];
  var keys = Object.keys(data);
  for (var i = 0; i < keys.length; i++) {
    var id = keys[i];
    list.push({
      id:     id,
      name:   data[id].name   || "",
      points: data[id].points || 0,
      stamps: data[id].stamps || 0
    });
  }
  list.sort(function(a, b) { return b.points - a.points; });
  var maxPts = list.length > 0 ? list[0].points : 0;
  var html   = "";
  for (var j = 0; j < list.length; j++) {
    var p         = list[j];
    var isMe      = (p.id === myId);
    var isLeading = (p.points > 0 && p.points === maxPts);
    var cls = "player-card" + (isMe ? " is-me" : "") + (isLeading ? " leading" : "");
    var crown = (isLeading && j === 0) ? "&#127942; " : "";
    html += "<div class='" + cls + "'>";
    html += "<div class='pc-name'>" + crown + p.name + "</div>";
    html += "<div class='pc-pts'>"  + p.points + "</div>";
    html += "<div class='pc-stamps'>" + p.stamps + " stamps</div>";
    html += "</div>";
  }
  document.getElementById("players-list").innerHTML = html;
}

// ---- END GAME ----
function promptEndGame() {
  showModal(
    "End the game?",
    "This will declare a winner for everyone and close the room.",
    "End Game",
    function() {
      db.ref("rooms/" + roomCode + "/ended").set(true);
    }
  );
}

function showWinnerScreen(data) {
  clearSession();
  var list = [];
  var keys = Object.keys(data);
  for (var i = 0; i < keys.length; i++) {
    var id = keys[i];
    list.push({ name: data[id].name || "", points: data[id].points || 0, stamps: data[id].stamps || 0 });
  }
  list.sort(function(a, b) { return b.points - a.points; });

  var winner = list[0] || { name: "Nobody", points: 0 };
  document.getElementById("winner-name").textContent = winner.name;
  document.getElementById("winner-pts").textContent  = winner.points + " points from " + winner.stamps + " stamps";

  var medals = ["&#127947;","&#129352;","&#129353;"];
  var boardHtml = "";
  for (var j = 0; j < list.length; j++) {
    var p   = list[j];
    var cls = j === 0 ? "wb-row first" : "wb-row";
    var medal = j < 3 ? medals[j] : (j+1) + ".";
    boardHtml += "<div class='" + cls + "'>";
    boardHtml += "<div class='wb-rank'>" + medal + "</div>";
    boardHtml += "<div class='wb-name'>" + p.name + "</div>";
    boardHtml += "<div class='wb-score'>" + p.points + "</div>";
    boardHtml += "</div>";
  }
  document.getElementById("winner-board").innerHTML = boardHtml;
  document.getElementById("winner-screen").classList.add("show");
}

// ---- STAMP ----
function addStamp() {
  if (!db) { return; }
  var name    = document.getElementById("person-name").value.trim();
  var country = document.getElementById("person-country").value.trim();
  var state   = document.getElementById("person-state").value.trim();
  if (!name)    { showToast("Enter the person's name!"); return; }
  if (!country) { showToast("Enter the country!"); return; }

  var stamp   = { name: name, country: country, state: state };
  var km      = distKmForStamp(stamp);
  var dp      = distPtsForKm(km);
  var mickey  = isMickeyName(name);
  stamp.km    = km;
  stamp.pts   = dp + (mickey ? MICKEY_BONUS : 0);
  stamp.mickey = mickey;
  myStamps.push(stamp);

  var totals = recalcTotals();
  document.getElementById("my-points").textContent    = totals.totalPts;
  document.getElementById("my-stamps").textContent    = myStamps.length;
  document.getElementById("my-countries").textContent = totals.countries;
  document.getElementById("my-states").textContent    = totals.states;

  db.ref("rooms/" + roomCode + "/players/" + myId).update({
    points:      totals.totalPts,
    stamps:      myStamps.length,
    countries:   totals.countries,
    states:      totals.states,
    stamps_data: myStamps
  });

  saveSession();
  renderMyStamps();

  document.getElementById("person-name").value    = "";
  document.getElementById("person-country").value = "";
  document.getElementById("person-state").value   = "";

  if (mickey) {
    setTimeout(function() { showMickeyBlast(name, stamp.pts); }, 200);
  } else {
    showToast("+" + dp + " pts - " + distLabel(km) + " from Disney!");
  }
}

// ---- EDIT STAMP ----
var editIndex = -1;

function openEditDrawer(index) {
  editIndex = index;
  var s = myStamps[index];
  document.getElementById("edit-name").value    = s.name;
  document.getElementById("edit-country").value = s.country;
  document.getElementById("edit-state").value   = s.state || "";
  document.getElementById("edit-overlay").classList.add("show");
}

function closeEditDrawer() {
  document.getElementById("edit-overlay").classList.remove("show");
  editIndex = -1;
}

function saveEditedStamp() {
  if (editIndex < 0) { return; }
  var name    = document.getElementById("edit-name").value.trim();
  var country = document.getElementById("edit-country").value.trim();
  var state   = document.getElementById("edit-state").value.trim();
  if (!name)    { showToast("Name cannot be empty!"); return; }
  if (!country) { showToast("Country cannot be empty!"); return; }

  var stamp    = { name: name, country: country, state: state };
  var km       = distKmForStamp(stamp);
  var dp       = distPtsForKm(km);
  var mickey   = isMickeyName(name);
  stamp.km     = km;
  stamp.pts    = dp + (mickey ? MICKEY_BONUS : 0);
  stamp.mickey = mickey;
  myStamps[editIndex] = stamp;

  syncTotals();
  closeEditDrawer();
  showToast("Stamp updated!");
}

function deleteStamp() {
  if (editIndex < 0) { return; }
  var name = myStamps[editIndex].name;
  closeEditDrawer();
  showModal(
    "Delete stamp?",
    "Remove " + name + " from your collection? This cannot be undone.",
    "Delete",
    function() {
      myStamps.splice(editIndex, 1);
      editIndex = -1;
      syncTotals();
      showToast("Stamp deleted.");
    }
  );
}

function syncTotals() {
  var totals = recalcTotals();
  document.getElementById("my-points").textContent    = totals.totalPts;
  document.getElementById("my-stamps").textContent    = myStamps.length;
  document.getElementById("my-countries").textContent = totals.countries;
  document.getElementById("my-states").textContent    = totals.states;
  // Write stamps_data so Firebase is the source of truth for stamp collection
  db.ref("rooms/" + roomCode + "/players/" + myId).update({
    points:      totals.totalPts,
    stamps:      myStamps.length,
    countries:   totals.countries,
    states:      totals.states,
    stamps_data: myStamps
  });
  saveSession();
  renderMyStamps();
}

function renderMyStamps() {
  var grid = document.getElementById("stamps-grid");
  if (myStamps.length === 0) {
    grid.innerHTML = "<div class='empty-stamps'><span class='empty-big'>&#9992;&#65039;</span>Ask someone where they are from!</div>";
    return;
  }
  var html = "";
  for (var i = myStamps.length - 1; i >= 0; i--) {
    var s       = myStamps[i];
    var cls     = "stamp " + (s.mickey ? "s-mickey" : stampClass(s.km));
    var fcode   = getFlag(s);
    var flagStr = s.mickey ? "&#128045;" : flagEmoji(fcode);
    var loc     = s.state ? (s.state + ", " + s.country) : s.country;
    var dist    = s.mickey ? "Mickey Bonus!" : distLabel(s.km);
    // data-idx stores the actual array index so taps work correctly
    html += "<div class='" + cls + "' data-idx='" + i + "'>";
    html += "<div class='stamp-pts'>+" + s.pts + "</div>";
    html += "<div class='stamp-flag'>" + flagStr + "</div>";
    html += "<div class='stamp-name'>" + s.name + "</div>";
    html += "<div class='stamp-loc'>"  + loc    + "</div>";
    html += "<div class='stamp-dist'>" + dist   + "</div>";
    html += "</div>";
  }
  grid.innerHTML = html;

  // Attach tap listeners to every stamp
  var stamps = grid.querySelectorAll(".stamp");
  for (var j = 0; j < stamps.length; j++) {
    stamps[j].addEventListener("click", function() {
      openEditDrawer(parseInt(this.getAttribute("data-idx"), 10));
    });
  }
}

// ---- LEAVE ----
function leaveGame() {
  showModal(
    "Leave game?",
    "Your stamps and score are saved. Use your room code to rejoin anytime.",
    "Yes, leave",
    function() {
      clearSession();
      location.reload();
    }
  );
}

// ---- BOOT ----
window.addEventListener("load", function() {
  try { initFirebase(); } catch(e) {
    document.getElementById("status-box").textContent = "Init error: " + e.message;
    document.getElementById("status-box").className = "status-box error";
  }

  // Wire up all buttons inside load so any parse-time errors above can't block this
  function on(id, fn) {
    var el = document.getElementById(id);
    if (el) { el.addEventListener("click", fn); }
  }

  on("btn-create",   createRoom);
  on("btn-enter",    enterGame);
  on("btn-join",     joinRoom);
  on("btn-stamp",    addStamp);
  on("btn-leave",    leaveGame);
  on("btn-end",      promptEndGame);
  on("btn-new-game", function() { clearSession(); location.reload(); });
  on("mickey-blast", function() {
    document.getElementById("mickey-blast").classList.remove("show");
  });
  on("modal-cancel", hideModal);
  on("modal-ok", function() {
    var fn = modalOkFn;
    hideModal();
    if (fn) { fn(); }
  });
  on("edit-save",   saveEditedStamp);
  on("edit-cancel", closeEditDrawer);
  on("edit-delete", deleteStamp);
  // Tap outside drawer to cancel
  document.getElementById("edit-overlay").addEventListener("click", function(e) {
    if (e.target === this) { closeEditDrawer(); }
  });

  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("service-worker.js").catch(function(err) {
      console.log("SW registration failed:", err);
    });
  }
});
</script>

</body>
</html>
